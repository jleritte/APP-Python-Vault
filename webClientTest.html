<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Python Client Test</title>
	<style>
		.checked{
			opacity: 0.5;
		}
	</style>
</head>
<body>
	<div class="chores"></div>
	<script>
		let data,
				ws = connectWS(),
				container = document.querySelector(".chores")

		function connectWS() {
			let ws = new WebSocket('ws://127.0.0.1:9001')
			ws.onopen = e => {
				console.log('Connected')
				messageWS(ws)
			}

			ws.onmessage = e => {
				data = groupBy(JSON.parse(e.data))
				update()
			}

			ws.onclose = e => {
				if(e.wasClean) {
					console.log(`Connection closed - code:${e.code}  reason:${e.reason}`)
				} else {
					console.log('Connection Died')
				}
			}

			ws.onerror = e => {
				console.log(`Error: ${e.message}`)
			}
			return ws
		}

		function messageWS(ws,m='list',t='') {ws.send(JSON.stringify({'action':m,'task':t}))}

		function closeWS(ws) {ws.close(1000,"End Communication")}

		function groupBy({chores,score}){
			let data = {}
			for(let i in chores){
				let item = [...chores[i],score[i][1],`${score[i][0]}${i}`], key = item[0]
				if(key in data){
					data[key].push(item)
				} else {
					data[key] = [item]
				}
			}
			return data
		}

		const labels = {'1':'Daily','7':'Weekly','30':'Monthly','90':'Three Months','180':'Six Months','360':'Annually'}

		function update() {
			for(let [section,chores] of Object.entries(data)) {
				let div = document.createElement('div'),tab = document.createElement('div')
				tab.innerText = labels[section]
				div.appendChild(tab)

				for(let chore of chores){
					let sub = document.createElement(`div`)
					sub.innerText = `${chore[1]}`
					if(chore[2]) {
						sub.classList.add('checked')
					}
					div.appendChild(sub)
				}
				container.appendChild(div)
			}
		}
	</script>
</body>
</html>